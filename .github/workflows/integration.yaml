name: Integration Tests

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: "1.21"
      - name: tests
        run: |
          echo "stop/disable mono"
          sudo systemctl stop mono-xsp4.service || true
          sudo systemctl disable mono-xsp4.service || true
          sudo pkill mono || true
          echo "check ports"
          sudo netstat -nlp | grep 8080 || true
          sudo netstat -nlp | grep 8081 || true
          sudo netstat -nlp | grep 8082 || true
          sudo netstat -nlp | grep 8083 || true
          sudo netstat -nlp | grep 8084 || true
          sudo netstat -nlp | grep 8085 || true
          echo "change to weather example directory"
          cd example/weather
          echo "run setup script"
          ./scripts/setup
          echo "run server"
          # ./scripts/server > /dev/null 2>&1 &
          # ./scripts/server &
          ./bin/forecaster -monitoring-enabled=false &
          ./bin/locator -monitoring-enabled=false &
          ./bin/tester -monitoring-enabled=false &
          ./bin/front -monitoring-enabled=false &
          echo "Sleep 3"
          sleep 3
          echo "-----RUN TESTS-----"
          results=$(curl -X POST http://localhost:8084/tester/smoke)
          echo "-----RESULTS-----"
          echo $results
          echo "----------"
          if [ $(echo $results | jq '.fail_count') -gt 0 ];
          then
            echo "Test errors found."
            exit 1
          else
            echo "Tests passed."
            exit 0
          fi
